"use strict";var google=google,Planner=Planner||{};Planner.init=function(){return this.apiURL="http://localhost:3000/api",this.$main=$("main"),$(".register").on("click",this.register.bind(this)),$(".login").on("click",this.login.bind(this)),$(".logout").on("click",this.logout.bind(this)),this.$main.on("click",".planDetail",this.showPlanDetail),this.$main.on("submit","form.auth",this.handleForm),this.$main.on("submit",".newPlanForm",this.newPlan),this.$main.on("click",".choosePerformance",this.choosePerformance),this.$main.on("submit",".budgetSearch",this.choosePerformanceByBudget),this.$main.on("click",".bookShow",this.bookShow),this.getToken()?(this.loggedInState(),Planner.loggedInUserID=window.atob(window.localStorage.getItem("token").split(".")[1]).split('"')[3],Planner.ajaxRequest(Planner.apiURL+"/users/"+Planner.loggedInUserID,"GET",null,function(e){e||(Planner.loggedOutState(),Planner.generateWelcomePage()),Planner.loggedInUser=e,Planner.showLoggedInUser(e)})):(Planner.loggedOutState(),void Planner.generateWelcomePage())},Planner.loggedOutState=function(){$(".login").show(),$(".register").show(),$(".logout").hide()},Planner.generateWelcomePage=function(){Planner.$main.html('<div class="jumbotron">\n  <div class="container">\n  <h1> <span class="brand"> Welcome! </span> </h1>\n  <h5>Ever had to plan the perfect evening but didn\'t know where to start? <br> <br>\n  Presenting <span class="brandSmall"> Make My Night </span>. The one stop shop to plan a great evening, with a partner or friends or family! </h5>\n  </div>\n  </div>')},Planner.login=function(e){e.preventDefault(),this.$main.html('\n    <div class="content">\n    <h2>Login</h2>\n    <form class="auth" method="post" action="/login">\n    <div class="form-group col-md-6">\n    <input class="form-control" type="email" name="emailAddress" placeholder="Email">\n    </div>\n    <div class="form-group col-md-6">\n    <input class="form-control" type="password" name="password" placeholder="Password">\n    </div>\n    <input class="btn btn-primary" type="submit" value="Login">\n    </form>\n    </div>\n    ')},Planner.register=function(e){e&&e.preventDefault(),this.$main.html('\n      <div class="content">\n      <h2>Register</h2>\n      <form class="auth" method="post" action="/register">\n      <span class="col-md-12" style="padding-left: 0px; padding-right: 0px;">\n      <div class="form-group col-md-6">\n      <input class="form-control" type="text" name="user[name]" placeholder="Fullname">\n      </div>\n      </span>\n      <div class="form-group col-md-6">\n      <input class="form-control" type="number" name="user[mobile]" placeholder="Mobile Number">\n      </div>\n      <div class="form-group col-md-6">\n      <input class="form-control" type="email" name="user[emailAddress]" placeholder="Email">\n      </div>\n      <div class="form-group col-md-6">\n      <input class="form-control" type="password" name="user[password]" placeholder="Password">\n      </div>\n      <div class="form-group col-md-6">\n      <input class="form-control" type="password" name="user[passwordConfirmation]" placeholder="Password Confirmation">\n      </div>\n      <input class="btn btn-primary" type="submit" value="Register">\n      </form>\n      </div>\n      ')},Planner.handleForm=function(e){e.preventDefault();var n=""+Planner.apiURL+$(this).attr("action"),a=$(this).attr("method"),t=$(this).serialize();return Planner.ajaxRequest(n,a,t,function(e){e.token&&Planner.setToken(e.token),Planner.showLoggedInUser(e.user),Planner.loggedInState()})},Planner.loggedInState=function(){$(".login").hide(),$(".register").hide(),$(".logout").show()},Planner.showLoggedInUser=function(e){Planner.ajaxRequest(Planner.apiURL+"/users/"+e._id,"GET",""+e._id,function(e){Planner.$main.html('<div class="content">\n        <img src="../images/profilePic.jpeg" alt="Davinder Kaur">\n        <h2>Hello....... '+e.name+"!</h2>\n        <h6> <b> Email: </b> "+e.emailAddress+"</h6>\n        <h6> <b> Phone: </b> "+e.mobile+'</h6>\n        <br>\n        <br>\n        <span class="col-md-12 newPlanSpan">\n        <form class="newPlanForm" method="post" action="/users/'+e._id+'/plans">\n        <div class="form-group col-md-3">\n        <input class="form-control" type="text" name="plan[name]" placeholder="Plan Name" required>\n        </div>\n        <div class="form-group col-md-3">\n        <input class="form-control" type="number" name="plan[attendees]" placeholder="No. of Attendees" required>\n        </div>\n        <div class="form-group col-md-3">\n        <button class="btn btn-primary"> Make a new Night Plan! </button>\n        </div>\n        </form>\n        </span>\n        <h5 class="previousPlans"> My Previous Plans</h5> </div>');for(var n=0;n<e.plans.length;n++)Planner.$main.append('<div class="appendContent"> <h6 class="previousPlans"> <a href="'+Planner.apiURL+"/users/"+e._id+"/plans/"+e.plans[n]._id+'" class="planDetail"> '+e.plans[n].name+" </a> on "+e.plans[n].date+" </h6> </div>")})},Planner.showPlanDetail=function(e){return e.preventDefault(),Planner.ajaxRequest(e.currentTarget.href,"GET",null,function(e){Planner.$main.html('<div class="content"> <a href="/"> Back to my page </a>\n        <h6> '+e.name+" ("+e.attendees+" people) on "+e.date+" </h6> </div>");for(var n=0;n<e.bookings.length;n++)Planner.$main.append('<div class="appendContent"> <h6> '+e.bookings[n].type+": "+e.bookings[n].description+"</h6> </div>")})},Planner.newPlan=function(e){e.preventDefault(),Planner.ajaxRequest(""+Planner.apiURL+$(this).attr("action"),"POST",$(this).serialize(),function(e){Planner.currentPlan=e}),Planner.loadMap(),Planner.addTheatres()},Planner.loadMap=function(){Planner.$main.html('<div id="map-canvas"></div>');var e=document.getElementById("map-canvas"),n={zoom:14,center:new google.maps.LatLng(51.510067,(-.133869)),mapTypeId:google.maps.MapTypeId.ROADMAP,styles:[{featureType:"administrative.neighborhood",elementType:"labels.text",stylers:[{visibility:"simplified"}]},{featureType:"administrative.land_parcel",elementType:"all",stylers:[{hue:"#ff4d00"},{saturation:6},{lightness:-31},{visibility:"off"}]},{featureType:"landscape.man_made",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",elementType:"geometry.fill",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",elementType:"labels.text",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",elementType:"labels.text.fill",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",elementType:"labels.text.stroke",stylers:[{visibility:"off"}]},{featureType:"landscape.man_made",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",elementType:"geometry",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",elementType:"geometry.fill",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",elementType:"geometry.stroke",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",elementType:"labels.text",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",elementType:"labels.text.fill",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",elementType:"labels.text.stroke",stylers:[{visibility:"off"}]},{featureType:"poi.attraction",elementType:"labels.icon",stylers:[{visibility:"off"}]},{featureType:"poi.business",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.government",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.medical",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.park",elementType:"all",stylers:[{hue:"#8aff00"},{saturation:17},{lightness:-2},{visibility:"on"}]},{featureType:"poi.park",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"poi.place_of_worship",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.school",elementType:"all",stylers:[{visibility:"off"}]},{featureType:"poi.sports_complex",elementType:"all",stylers:[{visibility:"on"}]},{featureType:"road",elementType:"labels.text",stylers:[{weight:"0.68"}]},{featureType:"road.highway",elementType:"all",stylers:[{hue:"#8aff00"},{saturation:-47},{lightness:-17},{visibility:"simplified"}]},{featureType:"road.arterial",elementType:"all",stylers:[{hue:"#ff0000"},{saturation:"-100"},{lightness:13},{visibility:"simplified"}]},{featureType:"road.local",elementType:"all",stylers:[{hue:"#ff0000"},{saturation:"97"},{lightness:100},{visibility:"simplified"}]},{featureType:"road.local",elementType:"labels",stylers:[{visibility:"off"}]},{featureType:"transit",elementType:"all",stylers:[{visibility:"simplified"}]},{featureType:"transit",elementType:"labels",stylers:[{visibility:"simplified"}]},{featureType:"transit",elementType:"labels.text",stylers:[{visibility:"off"}]},{featureType:"water",elementType:"all",stylers:[{hue:"#76aee3"},{saturation:38},{lightness:-11},{visibility:"on"}]}]};this.map=new google.maps.Map(e,n)},Planner.addTheatres=function(){return Planner.ajaxRequest(Planner.apiURL+"/venues","GET",null,function(e){$.each(e,function(e,n){var a="";$.each(n.events,function(e,n){a+='<li> <a href="#" class="choosePerformance" data-id="'+n.EventId+'"> '+n.Name+" </a> </li>"});var t={url:"images/mapmarker.png",scaledSize:new google.maps.Size(22,22),origin:new google.maps.Point(0,0),anchor:new google.maps.Point(0,0)};setTimeout(function(){var e=this,l=new google.maps.LatLng(n.latitude,n.longitude),i=new google.maps.Marker({position:l,map:Planner.map,animation:google.maps.Animation.DROP,icon:t});google.maps.event.addListener(i,"click",function(){"undefined"!=typeof e.infoWindow&&e.infoWindow.close(),e.infoWindow=new google.maps.InfoWindow({content:'<p class="theatre">'+n.name+' : <br> <ul class="theatreEvent"> '+a+" </ul> </p>"}),e.infoWindow.open(Planner.map,i),Planner.map.setCenter(i.getPosition()),Planner.map.setZoom(15)})},50*e)})})},Planner.choosePerformance=function(e){e.preventDefault(),void 0===Planner.tempBookingShowName&&(Planner.tempBookingShowName=e.target.innerHTML),Planner.ajaxRequest(Planner.apiURL+"/Events/"+$(this).data("id")+"/Performances","GET",null,function(e){var n=e.Performances.filter(function(e){return e.TotalAvailableTickesCount>Planner.currentPlan.attendees});Planner.$main.html(' <div class="content"> <h2> '+Planner.currentPlan.name+" : </h2> <br>\n        <h5> "+Planner.currentPlan.attendees+" tickets for "+Planner.tempBookingShowName+' </h5>\n        <p class="smallFont"> '+n.length+' options available </p>\n        <span class="col-md-12">\n        <h6 class="col-md-6"> Got a budget? Search by max ticket price </h6>\n        <span class="col-md-4">\n        <form class="budgetSearch" data-id='+e.EventId+'> <input class="form-control userBudget" type="number" name="userBudget" required> <button class="btn btn-primary"> Search </button> </form>\n        </span> </div> <br>');for(var a=0;a<n.length;a++){var t=moment(""+e.Performances[a].PerformanceDate).format("ddd Do MMM YYYY, h:mm a");Planner.$main.append('<div class="appendContent col-md-4"><h6>'+t+' <button class="bookShow" data-id="'+e.Performances[a].PerformanceDate+'"> Book </button> </h6> </div>')}})},Planner.choosePerformanceByBudget=function(e){e.preventDefault(),Planner.ajaxRequest(Planner.apiURL+"/Events/"+$(this).data("id")+"/Performances","GET",null,function(n){var a=n.Performances.filter(function(n){return n.MinimumTicketPrice<$(e.target).find(".userBudget").val()});Planner.$main.html(' <div class="content"> <h2> '+Planner.currentPlan.name+" :  </h2> <br>\n        <h5> "+Planner.currentPlan.attendees+" tickets for "+Planner.tempBookingShowName+" (max £ "+$(e.target).find(".userBudget").val()+' per ticket)</h5>\n        <p class="smallFont"> '+a.length+' options available </p>\n\n        <button class="btn btn-primary choosePerformance" data-id='+n.EventId+"> Back to full search </button> </div> ");for(var t=0;t<a.length;t++){var l=moment(""+n.Performances[t].PerformanceDate).format("ddd Do MMM YYYY, h:mm a");Planner.$main.append('<div class="appendContent col-md-4"> <h6>'+l+' <button class="bookShow" data-id="'+n.Performances[t].PerformanceDate+'"> Book </button> </h6> </div>')}})},Planner.bookShow=function(e){e.preventDefault(),Planner.currentPlan.date=$(e.target).attr("data-id");var n=Planner.currentPlan;Planner.ajaxRequest(Planner.apiURL+"/users/"+Planner.loggedInUserID+"/plans/"+Planner.currentPlan._id,"PUT",n,function(e){Planner.currentPlan=e;var n={type:"Show",description:Planner.tempBookingShowName};Planner.ajaxRequest(Planner.apiURL+"/users/"+Planner.loggedInUserID+"/plans/"+Planner.currentPlan._id,"POST",n,function(e){Planner.$main.html('<a href="/"> Back to my page </a>\n              <h6> '+e.name+" ("+e.attendees+" people) on "+e.date+" </h6>");for(var n=0;n<e.bookings.length;n++)Planner.$main.append('<div class="appendContent"> <h6> '+e.bookings[n].type+": "+e.bookings[n].description+" </h6> </div>")})})},Planner.logout=function(e){return e.preventDefault(),Planner.generateWelcomePage(),Planner.loggedOutState(),window.localStorage.clear()},Planner.getToken=function(){return window.localStorage.getItem("token")},Planner.ajaxRequest=function(e,n,a,t){return $.ajax({url:e,method:n,data:a,beforeSend:this.setRequestHeader.bind(this)}).done(t).fail(function(e){console.log(e)})},Planner.setToken=function(e){return window.localStorage.setItem("token",e)},Planner.setRequestHeader=function(e){return e.setRequestHeader("Authorization","Bearer "+this.getToken())},$(Planner.init.bind(Planner));